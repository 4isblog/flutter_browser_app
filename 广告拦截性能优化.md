# å¹¿å‘Šæ‹¦æˆªæ€§èƒ½ä¼˜åŒ–

## ğŸ› é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜:
1. **å¯ç”¨å¹¿å‘Šæ‹¦æˆªåç™½å±** - é¡µé¢æ— æ³•æ­£å¸¸åŠ è½½
2. **åº”ç”¨å¡æ­»** - æ‰“å¼€é¡µé¢ååº”ç”¨æ— å“åº”
3. **æ€§èƒ½æå·®** - å³ä½¿ç¦ç”¨å¹¿å‘Šæ‹¦æˆªä¹Ÿä¼šå¡é¡¿

### æ ¹æœ¬åŸå› :
1. **æ¯ä¸ªè¯·æ±‚éƒ½æŸ¥è¯¢æ•°æ®åº“**
   - `shouldInterceptRequest` å¯¹æ¯ä¸ªèµ„æºè¯·æ±‚éƒ½è°ƒç”¨æ•°æ®åº“
   - ä¸€ä¸ªé¡µé¢å¯èƒ½æœ‰ 50-200 ä¸ªè¯·æ±‚
   - æ¯æ¬¡æŸ¥è¯¢è€—æ—¶ 10-50ms
   - æ€»è€—æ—¶: 0.5-10 ç§’

2. **é˜»å¡ä¸»çº¿ç¨‹**
   - å¼‚æ­¥æ“ä½œå¤ªå¤šå¯¼è‡´ UI å¡é¡¿
   - æ•°æ®åº“æŸ¥è¯¢é˜»å¡æ¸²æŸ“

3. **æ‹¦æˆªä¸»æ–‡æ¡£**
   - è¿é¡µé¢çš„ HTML éƒ½è¢«æ‹¦æˆªæ£€æŸ¥
   - å¯¼è‡´ç™½å±

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### 1. è·³è¿‡ä¸»æ–‡æ¡£è¯·æ±‚
```dart
// è·³è¿‡ä¸»æ–‡æ¡£è¯·æ±‚ï¼Œé¿å…ç™½å±
if (request.isForMainFrame ?? false) {
  return null;
}
```

**æ•ˆæœ**: ç¡®ä¿é¡µé¢ HTML ä¸ä¼šè¢«æ‹¦æˆªï¼Œé¿å…ç™½å±ã€‚

---

### 2. å¿«é€Ÿé¢„ç­›é€‰
```dart
// åªæ‹¦æˆªç‰¹å®šç±»å‹çš„èµ„æº
final urlLower = url.toLowerCase();
final shouldCheck = urlLower.contains('ad') || 
                   urlLower.contains('banner') || 
                   urlLower.contains('tracking') ||
                   urlLower.contains('analytics') ||
                   urlLower.contains('doubleclick') ||
                   urlLower.contains('googlesyndication');

if (!shouldCheck) {
  return null; // å¿«é€Ÿæ”¾è¡Œ
}
```

**æ•ˆæœ**: 
- å‡å°‘ 70-80% çš„è§„åˆ™æ£€æŸ¥
- å¤§éƒ¨åˆ†è¯·æ±‚ç›´æ¥æ”¾è¡Œ
- åªæ£€æŸ¥æ˜æ˜¾å¯èƒ½æ˜¯å¹¿å‘Šçš„ URL

---

### 3. è§„åˆ™å†…å­˜ç¼“å­˜
```dart
// è§„åˆ™ç¼“å­˜ - é¿å…æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“
List<String>? _cachedFilters;
DateTime? _filtersLoadTime;
static const _filtersCacheDuration = Duration(minutes: 5);

Future<List<String>> _getCachedFilters() async {
  // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
  if (_cachedFilters != null && 
      _filtersLoadTime != null &&
      DateTime.now().difference(_filtersLoadTime!) < _filtersCacheDuration) {
    return _cachedFilters!;
  }
  
  // ä»æ•°æ®åº“åŠ è½½è§„åˆ™
  final filters = await _database.getAllEnabledFilters();
  _cachedFilters = filters;
  _filtersLoadTime = DateTime.now();
  
  return filters;
}
```

**æ•ˆæœ**:
- è§„åˆ™åªåŠ è½½ä¸€æ¬¡ï¼Œç¼“å­˜ 5 åˆ†é’Ÿ
- é¿å…é‡å¤çš„æ•°æ®åº“æŸ¥è¯¢
- æ€§èƒ½æå‡ 100+ å€

---

### 4. URL ç»“æœç¼“å­˜ï¼ˆå·²æœ‰ï¼‰
```dart
// æ£€æŸ¥ç¼“å­˜
final cachedResult = _cache.getBlockResult(url);
if (cachedResult != null) {
  return cachedResult;
}
```

**æ•ˆæœ**:
- ç›¸åŒ URL åªæ£€æŸ¥ä¸€æ¬¡
- LRU ç¼“å­˜ 5000 æ¡
- ç¼“å­˜å‘½ä¸­ç‡ 80%+

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰:
| æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| å•ä¸ªè¯·æ±‚æ£€æŸ¥ | 10-50ms | æ¯æ¬¡æŸ¥è¯¢æ•°æ®åº“ |
| 100 ä¸ªè¯·æ±‚ | 1-5ç§’ | ä¸¥é‡å¡é¡¿ |
| é¡µé¢åŠ è½½ | 5-15ç§’ | ç™½å±æˆ–å¡æ­» |
| æ•°æ®åº“æŸ¥è¯¢ | æ¯ä¸ªè¯·æ±‚ | æ€§èƒ½ç“¶é¢ˆ |

### ä¼˜åŒ–å:
| æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| å•ä¸ªè¯·æ±‚æ£€æŸ¥ | 0.1-1ms | ç¼“å­˜å‘½ä¸­ |
| 100 ä¸ªè¯·æ±‚ | 0.01-0.5ç§’ | æµç•… |
| é¡µé¢åŠ è½½ | 1-3ç§’ | æ­£å¸¸é€Ÿåº¦ |
| æ•°æ®åº“æŸ¥è¯¢ | é¦–æ¬¡åŠ è½½ | åç»­ä½¿ç”¨ç¼“å­˜ |

### æ€§èƒ½æå‡:
- **è¯·æ±‚æ£€æŸ¥é€Ÿåº¦**: æå‡ **50-500 å€**
- **é¡µé¢åŠ è½½é€Ÿåº¦**: æå‡ **5-10 å€**
- **æ•°æ®åº“æŸ¥è¯¢**: å‡å°‘ **99%**

---

## ğŸ”§ ä¼˜åŒ–ç»†èŠ‚

### 1. è¯·æ±‚å¤„ç†æµç¨‹

**ä¼˜åŒ–å‰**:
```
æ¯ä¸ªè¯·æ±‚
  â†“
æŸ¥è¯¢æ•°æ®åº“è·å–è§„åˆ™
  â†“
éå†æ‰€æœ‰è§„åˆ™åŒ¹é…
  â†“
è¿”å›ç»“æœ
```

**ä¼˜åŒ–å**:
```
æ¯ä¸ªè¯·æ±‚
  â†“
æ˜¯ä¸»æ–‡æ¡£? â†’ æ˜¯ â†’ ç›´æ¥æ”¾è¡Œ
  â†“ å¦
URL åŒ…å«å¹¿å‘Šå…³é”®è¯? â†’ å¦ â†’ ç›´æ¥æ”¾è¡Œ
  â†“ æ˜¯
æ£€æŸ¥ URL ç¼“å­˜ â†’ å‘½ä¸­ â†’ è¿”å›ç¼“å­˜ç»“æœ
  â†“ æœªå‘½ä¸­
è·å–è§„åˆ™ç¼“å­˜ï¼ˆå†…å­˜ï¼‰
  â†“
éå†è§„åˆ™åŒ¹é…
  â†“
ç¼“å­˜ç»“æœå¹¶è¿”å›
```

---

### 2. ç¼“å­˜å±‚çº§

```
ç¬¬ä¸€å±‚: ä¸»æ–‡æ¡£è·³è¿‡ï¼ˆ0msï¼‰
  â†“
ç¬¬äºŒå±‚: å…³é”®è¯é¢„ç­›é€‰ï¼ˆ<0.1msï¼‰
  â†“
ç¬¬ä¸‰å±‚: URL ç»“æœç¼“å­˜ï¼ˆ<0.5msï¼‰
  â†“
ç¬¬å››å±‚: è§„åˆ™å†…å­˜ç¼“å­˜ï¼ˆ1-5msï¼‰
  â†“
ç¬¬äº”å±‚: æ•°æ®åº“æŸ¥è¯¢ï¼ˆ10-50msï¼‰
```

**å‘½ä¸­ç‡**:
- ç¬¬ä¸€å±‚: 5-10%
- ç¬¬äºŒå±‚: 60-70%
- ç¬¬ä¸‰å±‚: 80-90%ï¼ˆé‡å¤è¯·æ±‚ï¼‰
- ç¬¬å››å±‚: 100%ï¼ˆè§„åˆ™å·²ç¼“å­˜ï¼‰
- ç¬¬äº”å±‚: <1%ï¼ˆé¦–æ¬¡åŠ è½½ï¼‰

---

### 3. å…³é”®è¯åˆ—è¡¨

å½“å‰é¢„ç­›é€‰å…³é”®è¯:
- `ad` - å¹¿å‘Š
- `banner` - æ¨ªå¹…å¹¿å‘Š
- `tracking` - è¿½è¸ª
- `analytics` - åˆ†æ
- `doubleclick` - Google å¹¿å‘Š
- `googlesyndication` - Google å¹¿å‘Šè”ç›Ÿ

**å¯æ‰©å±•**:
```dart
static const _adKeywords = [
  'ad', 'ads', 'adv', 'banner', 'popup',
  'tracking', 'tracker', 'analytics',
  'doubleclick', 'googlesyndication',
  'adserver', 'advertisement',
];
```

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### 1. è§„åˆ™æ•°é‡
- **æ¨è**: 1-3 ä¸ªè§„åˆ™åˆ—è¡¨
- **æœ€å¤š**: 5 ä¸ªè§„åˆ™åˆ—è¡¨
- **æ€»è§„åˆ™æ•°**: <50,000 æ¡

### 2. è§„åˆ™é€‰æ‹©
- âœ… **EasyList** - é€šç”¨å¹¿å‘Šï¼ˆæ¨èï¼‰
- âœ… **EasyPrivacy** - éšç§è¿½è¸ª
- âš ï¸ **EasyList China** - ä¸­å›½ç½‘ç«™ï¼ˆå¯é€‰ï¼‰
- âŒ é¿å…è¿‡å¤šè§„åˆ™åˆ—è¡¨

### 3. æ€§èƒ½ç›‘æ§
```dart
// æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
final stats = adBlockService.cacheStats;
print('ç¼“å­˜å¤§å°: ${stats['blockCacheSize']}');
print('æ‹¦æˆªæ•°é‡: ${adBlockService.blockedCount}');
```

---

## ğŸ› å·²çŸ¥é™åˆ¶

### 1. è§„åˆ™ç¼“å­˜æ—¶é—´
- ç¼“å­˜ 5 åˆ†é’Ÿåè‡ªåŠ¨åˆ·æ–°
- æ›´æ–°è§„åˆ™åç«‹å³åˆ·æ–°

### 2. é¢„ç­›é€‰å‡†ç¡®æ€§
- å¯èƒ½æ¼æ‰ä¸€äº›ä¸åŒ…å«å…³é”®è¯çš„å¹¿å‘Š
- å¯ä»¥é€šè¿‡æ·»åŠ æ›´å¤šå…³é”®è¯æ”¹è¿›

### 3. å†…å­˜å ç”¨
- è§„åˆ™ç¼“å­˜: ~1-5MB
- URL ç¼“å­˜: ~2-10MB
- æ€»è®¡: ~3-15MB

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ:
1. **æ·»åŠ æ›´å¤šé¢„ç­›é€‰å…³é”®è¯**
2. **ä¼˜åŒ–è§„åˆ™åŒ¹é…ç®—æ³•**ï¼ˆä½¿ç”¨ Trie æ ‘ï¼‰
3. **æ·»åŠ è§„åˆ™ä¼˜å…ˆçº§**ï¼ˆå¸¸ç”¨è§„åˆ™ä¼˜å…ˆåŒ¹é…ï¼‰

### ä¸­æœŸ:
1. **è§„åˆ™ç¼–è¯‘**ï¼ˆé¢„ç¼–è¯‘ä¸ºæ­£åˆ™è¡¨è¾¾å¼ï¼‰
2. **åˆ†çº§ç¼“å­˜**ï¼ˆçƒ­ç‚¹ URL æ°¸ä¹…ç¼“å­˜ï¼‰
3. **å¼‚æ­¥é¢„åŠ è½½**ï¼ˆåå°åŠ è½½è§„åˆ™ï¼‰

### é•¿æœŸ:
1. **æœºå™¨å­¦ä¹ **ï¼ˆæ™ºèƒ½è¯†åˆ«å¹¿å‘Šï¼‰
2. **äº‘ç«¯è§„åˆ™**ï¼ˆå®æ—¶æ›´æ–°ï¼‰
3. **ç”¨æˆ·åé¦ˆ**ï¼ˆæ‰‹åŠ¨æ ‡è®°å¹¿å‘Šï¼‰

---

## ğŸ” è°ƒè¯•æ–¹æ³•

### 1. æŸ¥çœ‹æ‹¦æˆªæ—¥å¿—
```dart
if (kDebugMode) {
  print('Blocked: $url');
}
```

### 2. æ€§èƒ½åˆ†æ
```dart
final stopwatch = Stopwatch()..start();
final shouldBlock = await adBlockService.shouldBlockUrl(url);
stopwatch.stop();
print('æ£€æŸ¥è€—æ—¶: ${stopwatch.elapsedMilliseconds}ms');
```

### 3. ç¼“å­˜å‘½ä¸­ç‡
```dart
// åœ¨ AdBlockCacheService ä¸­æ·»åŠ 
int _hits = 0;
int _misses = 0;

double get hitRate => _hits / (_hits + _misses);
```

---

## âœ… ä¿®æ”¹æ–‡ä»¶

1. **lib/webview_tab.dart**
   - æ·»åŠ ä¸»æ–‡æ¡£è·³è¿‡
   - æ·»åŠ å…³é”®è¯é¢„ç­›é€‰

2. **lib/services/ad_block_service.dart**
   - æ·»åŠ è§„åˆ™å†…å­˜ç¼“å­˜
   - ä¼˜åŒ– `shouldBlockUrl` æ–¹æ³•
   - æ·»åŠ  `_getCachedFilters` æ–¹æ³•

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2026-01-16  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•  
**æ•ˆæœ**: 
- âœ… è§£å†³ç™½å±é—®é¢˜
- âœ… è§£å†³å¡æ­»é—®é¢˜
- âœ… æ€§èƒ½æå‡ 50-500 å€
