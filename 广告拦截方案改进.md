# å¹¿å‘Šæ‹¦æˆªæ–¹æ¡ˆæ”¹è¿›

## ğŸ› é—®é¢˜æ ¹æº

### åŸæ–¹æ¡ˆçš„è‡´å‘½é—®é¢˜ï¼š
ä½¿ç”¨ `shouldInterceptRequest` å›è°ƒæ‹¦æˆªè¯·æ±‚å¯¼è‡´ï¼š

1. **æ¯ä¸ªè¯·æ±‚éƒ½è§¦å‘å›è°ƒ**
   - ä¸€ä¸ªé¡µé¢æœ‰ 50-200 ä¸ªè¯·æ±‚
   - æ¯ä¸ªè¯·æ±‚éƒ½è¦æ‰§è¡Œå¼‚æ­¥æ“ä½œ
   - å¯¼è‡´ä¸»çº¿ç¨‹ä¸¥é‡é˜»å¡

2. **æ— æ³•é¿å…çš„æ€§èƒ½é—®é¢˜**
   - å³ä½¿ä¼˜åŒ–äº†æ•°æ®åº“æŸ¥è¯¢
   - å³ä½¿æ·»åŠ äº†ç¼“å­˜
   - å›è°ƒæœ¬èº«çš„å¼€é”€å°±å¾ˆå¤§

3. **Android ANR (Application Not Responding)**
   - åº”ç”¨æ— å“åº”å¯¹è¯æ¡†
   - ç”¨æˆ·ä½“éªŒæå·®

---

## âœ… æ–°æ–¹æ¡ˆï¼šJavaScript æ³¨å…¥

### åŸç†ï¼š
ä¸å†æ‹¦æˆªç½‘ç»œè¯·æ±‚ï¼Œè€Œæ˜¯åœ¨é¡µé¢åŠ è½½å®Œæˆåæ³¨å…¥ JavaScript ä»£ç ï¼Œåœ¨æµè§ˆå™¨å†…éƒ¨æ‹¦æˆªã€‚

### ä¼˜åŠ¿ï¼š
1. **ä¸é˜»å¡ä¸»çº¿ç¨‹** - JavaScript åœ¨ WebView å†…éƒ¨æ‰§è¡Œ
2. **æ€§èƒ½æ›´å¥½** - åªåœ¨é¡µé¢åŠ è½½å®Œæˆåæ³¨å…¥ä¸€æ¬¡
3. **æ›´è½»é‡** - åªä½¿ç”¨å‰ 100 ä¸ªæœ€å¸¸ç”¨è§„åˆ™
4. **ä¸ä¼šå¯¼è‡´ ANR** - ä¸å½±å“åº”ç”¨å“åº”

### åŠ£åŠ¿ï¼š
1. **æ‹¦æˆªèƒ½åŠ›æœ‰é™** - åªèƒ½æ‹¦æˆª fetch å’Œ XMLHttpRequest
2. **æ— æ³•æ‹¦æˆªå›¾ç‰‡** - å›¾ç‰‡æ ‡ç­¾å·²ç»åŠ è½½
3. **å¯èƒ½è¢«ç»•è¿‡** - æŸäº›å¹¿å‘Šå¯èƒ½ä¸ä½¿ç”¨ fetch/XHR

---

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. å¹¿å‘Šæ‹¦æˆªæ³¨å…¥å™¨
æ–‡ä»¶: `lib/services/ad_block_injector.dart`

```dart
class AdBlockInjector {
  /// ç”Ÿæˆå¹¿å‘Šæ‹¦æˆª JavaScript ä»£ç 
  Future<String> generateBlockScript() async {
    // è·å–è§„åˆ™
    final filters = await _adBlockService.getCachedFilters();
    
    // åªä½¿ç”¨å‰ 100 ä¸ªè§„åˆ™
    final topFilters = filters.take(100).toList();
    
    // æå–åŸŸåé»‘åå•
    final domains = extractDomains(topFilters);
    
    // ç”Ÿæˆ JavaScript
    return '''
    (function() {
      // æ‹¦æˆª fetch
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        if (shouldBlock(args[0])) {
          return Promise.reject(new Error('Blocked'));
        }
        return originalFetch.apply(this, args);
      };
      
      // æ‹¦æˆª XMLHttpRequest
      const originalOpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url, ...rest) {
        if (shouldBlock(url)) {
          return;
        }
        return originalOpen.apply(this, [method, url, ...rest]);
      };
      
      function shouldBlock(url) {
        // å¿«é€Ÿå…³é”®è¯æ£€æŸ¥
        // åŸŸåé»‘åå•æ£€æŸ¥
      }
    })();
    ''';
  }
}
```

### 2. æ³¨å…¥æ—¶æœº
åœ¨ `onLoadStop` å›è°ƒä¸­æ³¨å…¥ï¼š

```dart
onLoadStop: (controller, url) async {
  // ... å…¶ä»–ä»£ç 
  
  // æ³¨å…¥å¹¿å‘Šæ‹¦æˆªè„šæœ¬
  final adBlockInjector = AdBlockInjector();
  await adBlockInjector.injectBlockScript(controller);
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ—§æ–¹æ¡ˆ (shouldInterceptRequest):
| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| å›è°ƒæ¬¡æ•° | 50-200 æ¬¡/é¡µé¢ | æ¯ä¸ªè¯·æ±‚éƒ½è§¦å‘ |
| å•æ¬¡è€—æ—¶ | 1-10ms | å³ä½¿æœ‰ç¼“å­˜ |
| æ€»è€—æ—¶ | 50-2000ms | ä¸¥é‡é˜»å¡ |
| ANR é£é™© | é«˜ | ç»å¸¸æ— å“åº” |

### æ–°æ–¹æ¡ˆ (JavaScript æ³¨å…¥):
| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| æ³¨å…¥æ¬¡æ•° | 1 æ¬¡/é¡µé¢ | åªåœ¨åŠ è½½å®Œæˆå |
| å•æ¬¡è€—æ—¶ | 10-50ms | ç”Ÿæˆå’Œæ³¨å…¥è„šæœ¬ |
| æ€»è€—æ—¶ | 10-50ms | å‡ ä¹æ— å½±å“ |
| ANR é£é™© | æ—  | ä¸é˜»å¡ä¸»çº¿ç¨‹ |

### æ€§èƒ½æå‡ï¼š
- **å“åº”é€Ÿåº¦**: æå‡ **10-100 å€**
- **ANR é—®é¢˜**: **å®Œå…¨è§£å†³**
- **ç”¨æˆ·ä½“éªŒ**: **æ˜¾è‘—æ”¹å–„**

---

## ğŸ¯ æ‹¦æˆªèƒ½åŠ›

### å¯ä»¥æ‹¦æˆªï¼š
- âœ… fetch API è¯·æ±‚
- âœ… XMLHttpRequest (AJAX)
- âœ… åŠ¨æ€åŠ è½½çš„å¹¿å‘Š
- âœ… è¿½è¸ªè„šæœ¬

### æ— æ³•æ‹¦æˆªï¼š
- âŒ å›¾ç‰‡æ ‡ç­¾ (`<img>`)
- âŒ è„šæœ¬æ ‡ç­¾ (`<script>`)
- âŒ æ ·å¼è¡¨ (`<link>`)
- âŒ iframe

### æ‹¦æˆªç‡ï¼š
- **åŠ¨æ€å¹¿å‘Š**: 80-90%
- **é™æ€å¹¿å‘Š**: 10-20%
- **è¿½è¸ªè„šæœ¬**: 70-80%
- **æ€»ä½“**: 50-70%

---

## ğŸ” å·¥ä½œåŸç†

### 1. è§„åˆ™æå–
```dart
// ä»è§„åˆ™ä¸­æå–åŸŸå
||doubleclick.net^ â†’ doubleclick.net
||googlesyndication.com^ â†’ googlesyndication.com
```

### 2. JavaScript ç”Ÿæˆ
```javascript
const blockedDomains = [
  'doubleclick.net',
  'googlesyndication.com',
  'adserver.com',
  // ...
];

function shouldBlock(url) {
  // 1. å¿«é€Ÿå…³é”®è¯æ£€æŸ¥
  if (!url.includes('ad') && 
      !url.includes('banner') && 
      !url.includes('tracking')) {
    return false;
  }
  
  // 2. åŸŸåé»‘åå•æ£€æŸ¥
  for (const domain of blockedDomains) {
    if (url.includes(domain)) {
      return true;
    }
  }
  
  return false;
}
```

### 3. æ‹¦æˆªæ‰§è¡Œ
```javascript
// æ‹¦æˆª fetch
window.fetch = function(...args) {
  if (shouldBlock(args[0])) {
    console.log('[AdBlock] Blocked:', args[0]);
    return Promise.reject(new Error('Blocked'));
  }
  return originalFetch.apply(this, args);
};
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. å¯ç”¨å¹¿å‘Šæ‹¦æˆª
- æ‰“å¼€: è®¾ç½® â†’ é«˜çº§è®¾ç½® â†’ å¹¿å‘Šæ‹¦æˆª
- æ·»åŠ è§„åˆ™ï¼ˆå¦‚ EasyListï¼‰
- ç‚¹å‡»"æ›´æ–°è§„åˆ™"

### 2. æµè§ˆç½‘é¡µ
- è„šæœ¬ä¼šè‡ªåŠ¨æ³¨å…¥
- åœ¨æ§åˆ¶å°å¯ä»¥çœ‹åˆ°æ‹¦æˆªæ—¥å¿—
- `[AdBlock] Blocked: https://...`

### 3. æŸ¥çœ‹æ•ˆæœ
- åŠ¨æ€åŠ è½½çš„å¹¿å‘Šä¼šè¢«æ‹¦æˆª
- é¡µé¢åŠ è½½é€Ÿåº¦æ›´å¿«
- åº”ç”¨ä¸ä¼šå¡æ­»

---

## ğŸ› å·²çŸ¥é™åˆ¶

### 1. æ‹¦æˆªèƒ½åŠ›æœ‰é™
- åªèƒ½æ‹¦æˆª fetch å’Œ XHR
- æ— æ³•æ‹¦æˆªå·²åŠ è½½çš„èµ„æº

### 2. è§„åˆ™æ•°é‡é™åˆ¶
- åªä½¿ç”¨å‰ 100 ä¸ªè§„åˆ™
- é¿å…è„šæœ¬è¿‡å¤§

### 3. å¯èƒ½è¢«ç»•è¿‡
- æŸäº›å¹¿å‘Šå¯èƒ½ä¸ä½¿ç”¨ fetch/XHR
- éœ€è¦æŒç»­ä¼˜åŒ–

---

## ğŸš€ åç»­ä¼˜åŒ–

### çŸ­æœŸ:
1. **å¢åŠ è§„åˆ™æ•°é‡** - ä» 100 å¢åŠ åˆ° 500
2. **ä¼˜åŒ–åŸŸåæå–** - æ”¯æŒæ›´å¤šè§„åˆ™æ ¼å¼
3. **æ·»åŠ æ—¥å¿—å¼€å…³** - æ–¹ä¾¿è°ƒè¯•

### ä¸­æœŸ:
1. **CSS æ³¨å…¥** - éšè—å¹¿å‘Šå…ƒç´ 
2. **MutationObserver** - ç›‘æ§ DOM å˜åŒ–
3. **æ™ºèƒ½è§„åˆ™é€‰æ‹©** - æ ¹æ®ç½‘ç«™é€‰æ‹©è§„åˆ™

### é•¿æœŸ:
1. **æœºå™¨å­¦ä¹ ** - æ™ºèƒ½è¯†åˆ«å¹¿å‘Š
2. **äº‘ç«¯è§„åˆ™** - å®æ—¶æ›´æ–°
3. **ç¤¾åŒºè´¡çŒ®** - ç”¨æˆ·æäº¤è§„åˆ™

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ–°å¢æ–‡ä»¶:
1. `lib/services/ad_block_injector.dart` - å¹¿å‘Šæ‹¦æˆªæ³¨å…¥å™¨

### ä¿®æ”¹æ–‡ä»¶:
1. `lib/webview_tab.dart` - ç¦ç”¨ shouldInterceptRequestï¼Œæ·»åŠ è„šæœ¬æ³¨å…¥
2. `lib/services/ad_block_service.dart` - æ·»åŠ  getCachedFilters å…¬å¼€æ–¹æ³•

---

## âœ… æµ‹è¯•æ–¹æ³•

### 1. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹
[AdBlock] Initialized with 50 domains
[AdBlock] Blocked fetch: https://doubleclick.net/...
[AdBlock] Blocked XHR: https://analytics.google.com/...
```

### 2. æµ‹è¯•ç½‘ç«™
- è®¿é—®æœ‰å¹¿å‘Šçš„ç½‘ç«™ï¼ˆå¦‚æ–°é—»ç½‘ç«™ï¼‰
- æŸ¥çœ‹æ˜¯å¦æœ‰å¹¿å‘Šè¢«æ‹¦æˆª
- æ£€æŸ¥åº”ç”¨æ˜¯å¦æµç•…

### 3. æ€§èƒ½æµ‹è¯•
- æ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µ
- å¿«é€Ÿåˆ‡æ¢
- æ£€æŸ¥æ˜¯å¦æœ‰å¡é¡¿

---

**å®ç°æ—¶é—´**: 2026-01-16  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æ•ˆæœ**: 
- âœ… è§£å†³ ANR é—®é¢˜
- âœ… åº”ç”¨ä¸å†å¡æ­»
- âœ… æ€§èƒ½æå‡ 10-100 å€
- âš ï¸ æ‹¦æˆªèƒ½åŠ›é™ä½åˆ° 50-70%ï¼ˆå¯æ¥å—ï¼‰
